(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[530,241],{7695:function(e,t,o){(window.__NEXT_P=window.__NEXT_P||[]).push(["/routes/[typeId]/[routeId]",function(){return o(7435)}])},1241:function(e,t,o){"use strict";o.d(t,{Xo:function(){return getRoutesByType},Z$:function(){return getEstimatedTravelTime},Zx:function(){return getRouteDirections},getRouteTypes:function(){return getRouteTypes},rN:function(){return getRouteStops}});var s=o(7066),r=o(2474),n=o.n(r),i=o(1876).Buffer;let a="3002834",c="f36b2876-d136-485d-8e06-f057c79c0998";console.log("PTV API Configuration:"),console.log("DEV_ID:",a),console.log("API_KEY exists:",!!c);let PTVApiError=class PTVApiError extends Error{constructor(e,t){super(e),this.name="PTVApiError",this.status=t}};async function generateSignature(e){let t;if(console.log("Generating signature for request:",e),!c)throw console.error("API Key is not defined"),Error("PTV API key is not defined");if(!a)throw console.error("Developer ID is not defined"),Error("PTV Developer ID is not defined");e.includes("devid=")?(console.log("Request already has devid parameter, using as is"),t=e):t=e+(e.includes("?")?"&":"?")+"devid="+a,console.log("Request with DevID:",t);try{console.log("Running in browser environment");try{console.log("Attempting to use SubtleCrypto API");let e=new TextEncoder,o=e.encode(c),s=e.encode(t),r=await window.crypto.subtle.importKey("raw",o,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),n=await window.crypto.subtle.sign("HMAC",r,s),i=Array.from(new Uint8Array(n)),a=i.map(e=>e.toString(16).padStart(2,"0")).join(""),l=a.toUpperCase();return console.log("Generated signature using SubtleCrypto:",l.substring(0,6)+"..."),l}catch(e){console.error("SubtleCrypto failed:",e),console.log("Falling back to server-side implementation")}let e=i.from(c,"utf-8"),o=n().createHmac("sha1",e);o.update(t);let s=o.digest("hex").toUpperCase();return console.log("Generated signature using Node.js crypto:",s.substring(0,6)+"..."),s}catch(e){throw console.error("Error generating signature:",e),e instanceof Error&&console.error("Error details:",{name:e.name,message:e.message,stack:e.stack}),Error("Failed to generate signature: ".concat(e instanceof Error?e.message:String(e)))}}async function ptvApiRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(console.log("PTV API Request - Endpoint: ".concat(e)),!a)throw console.error("PTV API Error: Developer ID is not defined"),Error("PTV Developer ID is not defined");let o=new URLSearchParams;Object.entries(t).forEach(e=>{let[t,s]=e;o.append(t,String(s))});let r=e+(Object.keys(t).length>0?"?"+o.toString():"");console.log("Request Path (before devid): ".concat(r)),console.log("Using Developer ID: ".concat(a.substring(0,3),"..."));try{let t=await generateSignature(r);console.log("Generated Signature: ".concat(t.substring(0,6),"...")),o.append("devid",a),o.append("signature",t);let n="".concat("https://timetableapi.ptv.vic.gov.au").concat(e,"?").concat(o.toString());console.log("Full API URL: ".concat(n)),console.log("Sending API request...");let i=await s.Z.get(n);return console.log("API Response received:",{status:i.status,statusText:i.statusText,dataSize:JSON.stringify(i.data).length}),i.data}catch(e){if(console.error("PTV API Request failed:",e),s.Z.isAxiosError(e)){var n,i,c,l,u,d;if(console.error("Axios Error Details:",{status:null===(n=e.response)||void 0===n?void 0:n.status,statusText:null===(i=e.response)||void 0===i?void 0:i.statusText,data:null===(c=e.response)||void 0===c?void 0:c.data,message:e.message,config:{url:null===(l=e.config)||void 0===l?void 0:l.url,method:null===(u=e.config)||void 0===u?void 0:u.method,headers:null===(d=e.config)||void 0===d?void 0:d.headers}}),e.response)throw new PTVApiError("PTV API error: ".concat(e.response.status," ").concat(e.response.statusText),e.response.status)}throw Error("PTV API request failed: ".concat(e instanceof Error?e.message:String(e)))}}async function getRouteTypes(){return ptvApiRequest("/v3/route_types")}async function getRoutesByType(e){return ptvApiRequest("/v3/routes",{route_types:e})}async function getRouteDirections(e){return ptvApiRequest("/v3/directions/route/".concat(e))}async function getRouteStops(e,t,o){let s={};void 0!==o?(s.direction_id=o,console.log("Getting stops for route ".concat(e,", type ").concat(t,", direction ").concat(o))):console.log("WARNING: No direction_id specified for route ".concat(e,". Stops may not be in correct sequence.")),s.include_distance="true",console.log("Requesting stop_sequence information"),s.stop_disruptions="false",s.include_geopath="false",s.max_results=1e3;try{let o=await ptvApiRequest("/v3/stops/route/".concat(e,"/route_type/").concat(t),s);if(o&&o.stops&&o.stops.length>0){let e=o.stops;console.log("Received ".concat(e.length," stops with sequence info:"),e.slice(0,3).map(e=>({id:e.stop_id,name:e.stop_name,sequence:e.stop_sequence})))}return o}catch(o){throw console.error("Error fetching stops for route ".concat(e,", type ").concat(t,":"),o),o}}async function getStopDetails(e,t){return ptvApiRequest("/v3/stops/".concat(e,"/route_type/").concat(t),{stop_location:"true",stop_amenities:"true",stop_accessibility:"true"})}async function getJourneyBetweenStops(e,t,o){let s=new Date,r=new Date(s.toLocaleString("en-US",{timeZone:"Australia/Melbourne"})),n=r.toISOString().split("T")[0],i=r.toTimeString().split(" ")[0].substring(0,5);return ptvApiRequest("/v3/journey",{from_stop_id:e,to_stop_id:t,route_types:o,date:n,time:i,max_results:1})}async function getEstimatedTravelTime(e,t,o){try{let s=await getJourneyBetweenStops(e,t,o);if(s.journeys&&s.journeys.length>0)return s.journeys[0].duration_mins;throw Error("No journey data available")}catch(s){return console.error("Error getting travel time from PTV API:",s),estimateTravelTimeFallback(e,t,o)}}async function estimateTravelTimeFallback(e,t,o){try{let s=await getStopDetails(e,o),r=await getStopDetails(t,o),n=s.stop.stop_latitude,i=s.stop.stop_longitude,a=r.stop.stop_latitude,c=r.stop.stop_longitude,l=function(e,t,o,s){let r=(o-e)*(Math.PI/180),n=(s-t)*(Math.PI/180),i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(n/2)*Math.sin(n/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}(n,i,a,c)/1e3,u={0:40,1:20,2:25,3:40,4:25,5:80}[o]||30;return Math.ceil(1.2*(60*(l/u)))}catch(e){return console.error("Error in fallback travel time estimation:",e),({0:5,1:3,2:4,3:10,4:4,5:15})[o]||5}}},7435:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return RouteDetail}});var s=o(5893),r=o(7294),n=o(1163),i=o(9008),a=o.n(i),c=o(1664),l=o.n(c),u=o(2441),d=o(1241),g=o(1643);let p={0:"train-blue",1:"tram-green",2:"bus-orange",3:"train-blue"};function RouteDetail(){var e,t,o;let i=(0,n.useRouter)(),{typeId:c,routeId:m}=i.query,[h,f]=(0,r.useState)([]),[b,v]=(0,r.useState)(null),[y,x]=(0,r.useState)([]),[_,N]=(0,r.useState)(!0),[w,S]=(0,r.useState)(null),[j,E]=(0,r.useState)(""),[P,q]=(0,r.useState)("");(0,r.useEffect)(()=>{if(!c||!m)return;let fetchDirections=async()=>{try{let e;N(!0),S(null);try{let e=localStorage.getItem("directions_route_".concat(m));if(e){let t=JSON.parse(e);f(t.directions),E(t.routeName||""),q(t.routeNumber||""),console.log("Loaded cached route number: ".concat(t.routeNumber)),t.directions.length>0&&!b&&v(t.directions[0].direction_id),N(!1);return}}catch(e){console.error("LocalStorage error:",e)}console.log("Using PTV API for route type ".concat(c)),e=await (0,d.Zx)(Number(m)),f(e.directions),e.directions.length>0&&v(e.directions[0].direction_id);let t="",o="";try{let e=await (0,d.Xo)(Number(c)),s=e.routes.find(e=>e.route_id===Number(m));s&&(t=s.route_name,o=s.route_number,E(t),q(o),console.log("Found route: ".concat(t,", number: ").concat(o)))}catch(e){console.error("Error fetching route details:",e)}try{localStorage.setItem("directions_route_".concat(m),JSON.stringify({directions:e.directions,routeName:t,routeNumber:o,timestamp:Date.now()})),console.log("Cached route data with name: ".concat(t,", number: ").concat(o))}catch(e){console.error("LocalStorage saving error:",e)}N(!1)}catch(e){S("Failed to load route directions. Please try again later."),N(!1),console.error("Error fetching directions:",e)}};fetchDirections()},[c,m,b,!0]),(0,r.useEffect)(()=>{if(!c||!m||null===b)return;let fetchStops=async()=>{try{N(!0),S(null);try{let e="stops_route_".concat(m,"_").concat(b),t=localStorage.getItem(e);if(t){let e=JSON.parse(t),o=e.stops.map(e=>({...e,nearbyGigs:[],isLoadingGigs:!1}));x(o),N(!1);return}}catch(e){console.error("LocalStorage error:",e)}let e={stops:[],status:{version:"",health:1}};try{if(1===Number(c)&&(11===Number(m)||96===Number(m))){console.log("Using PTV API with fallback for tram route ".concat(m));try{e=await (0,d.rN)(Number(m),Number(c),b)}catch(r){console.error("Error fetching stops for tram route ".concat(m,", trying alternative direction:"),r),console.log("Fetching all available directions for route ".concat(m));let t=await (0,d.Zx)(Number(m)),o=t.directions.map(e=>e.direction_id);console.log("Available directions for route ".concat(m,":"),o);let s=o.filter(e=>e!==b);if(s.length>0){let t=!1;for(let o of s){console.log("Trying alternative direction ".concat(o," for route ").concat(m));try{e=await (0,d.rN)(Number(m),Number(c),o),console.log("Successfully fetched stops using alternative direction ".concat(o)),t=!0;break}catch(e){console.error("Direction ".concat(o," also failed:"),e)}}if(!t)throw Error("All available directions failed")}else throw Error("No alternative directions available")}}else console.log("Using PTV API for route type ".concat(c)),e=await (0,d.rN)(Number(m),Number(c),b)}catch(t){console.error("Error fetching stops:",t),e={stops:[],status:{version:"",health:0}}}console.log("Raw stops response:",e.stops);let t=e.stops.some(e=>void 0!==e.stop_sequence);console.log("Has stop_sequence property:",t),console.log("All stops with sequence info:",e.stops.map(e=>({name:e.stop_name,id:e.stop_id,sequence:e.stop_sequence}))),console.log("Processing stops - using API stop_sequence for ordering");let o=[...e.stops].sort((e,t)=>{if(e.stop_sequence&&t.stop_sequence)return e.stop_sequence-t.stop_sequence;if(e.stop_sequence)return -1;if(t.stop_sequence)return 1;let o=e.stop_name.match(/#(\d+)/),s=t.stop_name.match(/#(\d+)/);return o&&s?parseInt(o[1])-parseInt(s[1]):e.stop_id-t.stop_id});console.log("Sorted stops:",o.map(e=>({name:e.stop_name,sequence:e.absolute_sequence,original_sequence:e.stop_sequence}))),console.log("Sorted stops:",o.map(e=>({name:e.stop_name,sequence:e.stop_sequence,id:e.stop_id})));let s=o.map(e=>({...e,nearbyGigs:[],isLoadingGigs:!1}));x(s);try{let e="stops_route_".concat(m,"_").concat(b);localStorage.setItem(e,JSON.stringify({stops:o,timestamp:Date.now()}))}catch(e){console.error("LocalStorage saving error:",e)}N(!1)}catch(e){S("Failed to load stops. Please try again later."),N(!1),console.error("Error fetching stops:",e)}};fetchStops()},[c,m,b,!0]);let loadGigsForStop=async e=>{console.log("Loading gigs for stop index ".concat(e));let t=y[e];if(console.log("Stop details:",{name:t.stop_name,latitude:t.stop_latitude,longitude:t.stop_longitude,isLoadingGigs:t.isLoadingGigs,hasGigs:t.nearbyGigs.length>0}),t.isLoadingGigs||t.nearbyGigs.length>0){console.log("Skipping - already loading or has gigs");return}let o=[...y];o[e]={...t,isLoadingGigs:!0},x(o),console.log("Updated loading state to true");try{console.log("Calling findGigsNearLocation with:",{latitude:t.stop_latitude,longitude:t.stop_longitude,radius:500});let o=await (0,g.E)(t.stop_latitude,t.stop_longitude,500);console.log("Found ".concat(o.length," gigs near ").concat(t.stop_name));let s=[...y];s[e]={...t,nearbyGigs:o,isLoadingGigs:!1},x(s),console.log("Updated stops with gigs")}catch(s){console.error("Error fetching gigs for stop:",s),s instanceof Error&&console.error("Error details:",{name:s.name,message:s.message,stack:s.stack});let o=[...y];o[e]={...t,isLoadingGigs:!1,nearbyGigs:[]},x(o),console.log("Updated loading state to false after error")}},T=c&&p[c]||"ptv-blue";return(0,s.jsxs)(u.Z,{children:[(0,s.jsx)(a(),{children:(0,s.jsxs)("title",{children:["PTV-LML | ",P&&1===Number(c)?"Number ".concat(P,": "):"",P&&2===Number(c)?"Route ".concat(P,": "):"",j||"Route"," Stops"]})}),(0,s.jsxs)("div",{className:"container py-8",children:[(0,s.jsxs)("div",{className:"mb-8",children:[(0,s.jsxs)(l(),{href:"/routes/".concat(c),className:"text-ptv-blue hover:underline mb-4 inline-flex items-center",children:[(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z",clipRule:"evenodd"})}),"Back to Routes"]}),(0,s.jsxs)("h1",{className:"text-3xl font-bold text-".concat(T," mb-2 md:text-4xl"),children:[P&&1===Number(c)?"Number ".concat(P,": "):"",P&&2===Number(c)?"Route ".concat(P,": "):"",j||"Route"," Stops"]}),(0,s.jsx)("p",{className:"text-gray-600",children:"View all stops and nearby live music events."})]}),h.length>0&&(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("fieldset",{children:[(0,s.jsx)("legend",{className:"text-lg font-semibold mb-2",children:"Select Direction:"}),(0,s.jsx)("div",{className:"space-y-2 mb-2",children:h.map(e=>{let t=e.direction_name;t.toLowerCase().startsWith("to ")||(t="To ".concat(t));let o=b===e.direction_id,r="direction-".concat(e.direction_id);return(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",id:r,name:"direction",value:e.direction_id,checked:o,onChange:()=>v(e.direction_id),className:"w-5 h-5 text-".concat(T," focus:ring-").concat(T," border-gray-300")}),(0,s.jsx)("label",{htmlFor:r,className:"ml-2 text-base ".concat(o?"font-bold":"font-normal"),children:t})]},e.direction_id)})})]}),null!==b&&h.length>0&&(0,s.jsxs)("div",{className:"text-sm bg-".concat(T," bg-opacity-10 text-").concat(T," p-2 rounded-md mt-2 inline-block"),children:["Currently showing stops heading ",(null===(e=h.find(e=>e.direction_id===b))||void 0===e?void 0:e.direction_name.toLowerCase().startsWith("to "))?null===(t=h.find(e=>e.direction_id===b))||void 0===t?void 0:t.direction_name:"to ".concat(null===(o=h.find(e=>e.direction_id===b))||void 0===o?void 0:o.direction_name)]})]}),_?(0,s.jsx)("div",{className:"flex justify-center items-center py-12",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-ptv-blue"})}):w?(0,s.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[(0,s.jsx)("strong",{className:"font-bold",children:"Error!"}),(0,s.jsxs)("span",{className:"block sm:inline",children:[" ",w]})]}):(0,s.jsxs)("div",{className:"space-y-4",children:[y.map((e,t)=>(0,s.jsx)("div",{className:"card",children:(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold",children:e.stop_name}),(0,s.jsx)("div",{className:"mt-2",children:e.isLoadingGigs?(0,s.jsxs)("p",{className:"text-gray-500 text-sm flex items-center",children:[(0,s.jsx)("span",{className:"inline-block w-4 h-4 mr-2 border-t-2 border-b-2 border-ptv-blue rounded-full animate-spin"}),"Loading nearby gigs..."]}):e.nearbyGigs.length>0?(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-sm font-medium text-music-purple mb-1",children:[e.nearbyGigs.length," Live Music ",1===e.nearbyGigs.length?"Event":"Events"," Nearby"]}),(0,s.jsxs)("ul",{className:"text-sm text-gray-600 space-y-1",children:[e.nearbyGigs.slice(0,3).map(e=>(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"inline-block w-2 h-2 mt-1.5 mr-2 bg-music-purple rounded-full"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"font-medium",children:e.name}),(0,s.jsxs)("span",{className:"text-gray-500",children:[" at ",e.venue.name]}),(0,s.jsxs)("span",{className:"text-gray-400 block text-xs",children:[Math.round(e.distance_meters||0),"m away"]})]})]},e.id)),e.nearbyGigs.length>3&&(0,s.jsxs)("li",{className:"text-music-purple text-xs font-medium",children:["+",e.nearbyGigs.length-3," more events"]})]})]}):(0,s.jsx)("button",{className:"text-sm text-music-purple hover:underline focus:outline-none",onClick:()=>loadGigsForStop(t),children:"Check for nearby gigs"})}),(0,s.jsx)("div",{className:"mt-2 border-t pt-2",children:(0,s.jsxs)(l(),{href:"/routes/".concat(c,"/").concat(m,"/direction/").concat(b,"/stop/").concat(e.stop_id,"/stops-ahead"),className:"text-sm text-music-purple hover:underline focus:outline-none inline-flex items-center",children:[(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z",clipRule:"evenodd"})}),"View gigs at stops ahead"]})})]})},e.stop_id)),0===y.length&&!_&&!w&&(0,s.jsx)("div",{className:"text-center py-8",children:(0,s.jsx)("p",{className:"text-gray-500",children:"No stops found for this route and direction."})})]})]})]})}}},function(e){e.O(0,[714,664,675,66,817,910,774,888,179],function(){return e(e.s=7695)}),_N_E=e.O()}]);