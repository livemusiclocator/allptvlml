(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[753,241],{7026:function(e,t,o){(window.__NEXT_P=window.__NEXT_P||[]).push(["/routes/[typeId]/[routeId]/direction/[directionId]/stop/[stopId]/stops-ahead",function(){return o(7708)}])},1241:function(e,t,o){"use strict";o.d(t,{Xo:function(){return getRoutesByType},Z$:function(){return getEstimatedTravelTime},Zx:function(){return getRouteDirections},getRouteTypes:function(){return getRouteTypes},rN:function(){return getRouteStops}});var s=o(7066),r=o(2474),n=o.n(r),a=o(1876).Buffer;let i="3002834",l="f36b2876-d136-485d-8e06-f057c79c0998";console.log("PTV API Configuration:"),console.log("DEV_ID:",i),console.log("API_KEY exists:",!!l);let PTVApiError=class PTVApiError extends Error{constructor(e,t){super(e),this.name="PTVApiError",this.status=t}};async function generateSignature(e){let t;if(console.log("Generating signature for request:",e),!l)throw console.error("API Key is not defined"),Error("PTV API key is not defined");if(!i)throw console.error("Developer ID is not defined"),Error("PTV Developer ID is not defined");e.includes("devid=")?(console.log("Request already has devid parameter, using as is"),t=e):t=e+(e.includes("?")?"&":"?")+"devid="+i,console.log("Request with DevID:",t);try{console.log("Running in browser environment");try{console.log("Attempting to use SubtleCrypto API");let e=new TextEncoder,o=e.encode(l),s=e.encode(t),r=await window.crypto.subtle.importKey("raw",o,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),n=await window.crypto.subtle.sign("HMAC",r,s),a=Array.from(new Uint8Array(n)),i=a.map(e=>e.toString(16).padStart(2,"0")).join(""),c=i.toUpperCase();return console.log("Generated signature using SubtleCrypto:",c.substring(0,6)+"..."),c}catch(e){console.error("SubtleCrypto failed:",e),console.log("Falling back to server-side implementation")}let e=a.from(l,"utf-8"),o=n().createHmac("sha1",e);o.update(t);let s=o.digest("hex").toUpperCase();return console.log("Generated signature using Node.js crypto:",s.substring(0,6)+"..."),s}catch(e){throw console.error("Error generating signature:",e),e instanceof Error&&console.error("Error details:",{name:e.name,message:e.message,stack:e.stack}),Error("Failed to generate signature: ".concat(e instanceof Error?e.message:String(e)))}}async function ptvApiRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(console.log("PTV API Request - Endpoint: ".concat(e)),!i)throw console.error("PTV API Error: Developer ID is not defined"),Error("PTV Developer ID is not defined");let o=new URLSearchParams;Object.entries(t).forEach(e=>{let[t,s]=e;o.append(t,String(s))});let r=e+(Object.keys(t).length>0?"?"+o.toString():"");console.log("Request Path (before devid): ".concat(r)),console.log("Using Developer ID: ".concat(i.substring(0,3),"..."));try{let t=await generateSignature(r);console.log("Generated Signature: ".concat(t.substring(0,6),"...")),o.append("devid",i),o.append("signature",t);let n="".concat("https://timetableapi.ptv.vic.gov.au").concat(e,"?").concat(o.toString());console.log("Full API URL: ".concat(n)),console.log("Sending API request...");let a=await s.Z.get(n);return console.log("API Response received:",{status:a.status,statusText:a.statusText,dataSize:JSON.stringify(a.data).length}),a.data}catch(e){if(console.error("PTV API Request failed:",e),s.Z.isAxiosError(e)){var n,a,l,c,u,d;if(console.error("Axios Error Details:",{status:null===(n=e.response)||void 0===n?void 0:n.status,statusText:null===(a=e.response)||void 0===a?void 0:a.statusText,data:null===(l=e.response)||void 0===l?void 0:l.data,message:e.message,config:{url:null===(c=e.config)||void 0===c?void 0:c.url,method:null===(u=e.config)||void 0===u?void 0:u.method,headers:null===(d=e.config)||void 0===d?void 0:d.headers}}),e.response)throw new PTVApiError("PTV API error: ".concat(e.response.status," ").concat(e.response.statusText),e.response.status)}throw Error("PTV API request failed: ".concat(e instanceof Error?e.message:String(e)))}}async function getRouteTypes(){return ptvApiRequest("/v3/route_types")}async function getRoutesByType(e){return ptvApiRequest("/v3/routes",{route_types:e})}async function getRouteDirections(e){return ptvApiRequest("/v3/directions/route/".concat(e))}async function getRouteStops(e,t,o){let s={};void 0!==o?(s.direction_id=o,console.log("Getting stops for route ".concat(e,", type ").concat(t,", direction ").concat(o))):console.log("WARNING: No direction_id specified for route ".concat(e,". Stops may not be in correct sequence.")),s.include_distance="true",console.log("Requesting stop_sequence information"),s.stop_disruptions="false",s.include_geopath="false",s.max_results=1e3;try{let o=await ptvApiRequest("/v3/stops/route/".concat(e,"/route_type/").concat(t),s);if(o&&o.stops&&o.stops.length>0){let e=o.stops;console.log("Received ".concat(e.length," stops with sequence info:"),e.slice(0,3).map(e=>({id:e.stop_id,name:e.stop_name,sequence:e.stop_sequence})))}return o}catch(o){throw console.error("Error fetching stops for route ".concat(e,", type ").concat(t,":"),o),o}}async function getStopDetails(e,t){return ptvApiRequest("/v3/stops/".concat(e,"/route_type/").concat(t),{stop_location:"true",stop_amenities:"true",stop_accessibility:"true"})}async function getJourneyBetweenStops(e,t,o){let s=new Date,r=new Date(s.toLocaleString("en-US",{timeZone:"Australia/Melbourne"})),n=r.toISOString().split("T")[0],a=r.toTimeString().split(" ")[0].substring(0,5);return ptvApiRequest("/v3/journey",{from_stop_id:e,to_stop_id:t,route_types:o,date:n,time:a,max_results:1})}async function getEstimatedTravelTime(e,t,o){try{let s=await getJourneyBetweenStops(e,t,o);if(s.journeys&&s.journeys.length>0)return s.journeys[0].duration_mins;throw Error("No journey data available")}catch(s){return console.error("Error getting travel time from PTV API:",s),estimateTravelTimeFallback(e,t,o)}}async function estimateTravelTimeFallback(e,t,o){try{let s=await getStopDetails(e,o),r=await getStopDetails(t,o),n=s.stop.stop_latitude,a=s.stop.stop_longitude,i=r.stop.stop_latitude,l=r.stop.stop_longitude,c=function(e,t,o,s){let r=(o-e)*(Math.PI/180),n=(s-t)*(Math.PI/180),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(n/2)*Math.sin(n/2);return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}(n,a,i,l)/1e3,u={0:40,1:20,2:25,3:40,4:25,5:80}[o]||30;return Math.ceil(1.2*(60*(c/u)))}catch(e){return console.error("Error in fallback travel time estimation:",e),({0:5,1:3,2:4,3:10,4:4,5:15})[o]||5}}},7708:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return StopsAhead}});var s=o(5893),r=o(7294),n=o(1163),a=o(9008),i=o.n(a),l=o(1664),c=o.n(l),u=o(2441),d=o(1241),p=o(1643);let m={0:"train-blue",1:"tram-green",2:"bus-orange",3:"train-blue"};function StopsAhead(){let e=(0,n.useRouter)(),{typeId:t,routeId:o,directionId:a,stopId:l}=e.query,[g,h]=(0,r.useState)(null),[f,v]=(0,r.useState)([]),[x,b]=(0,r.useState)([]),[_,y]=(0,r.useState)(!0),[N,w]=(0,r.useState)(null);(0,r.useEffect)(()=>{if(!t||!o||!l||!a)return;let fetchStopsAndGigs=async()=>{try{y(!0),w(null);let e={stops:[],status:{version:"",health:1}};try{if(1===Number(t)&&(11===Number(o)||96===Number(o))){console.log("Using PTV API with special handling for tram route ".concat(o));try{e=await (0,d.rN)(Number(o),Number(t),Number(a))}catch(i){console.error("Error fetching stops for tram route ".concat(o,", trying alternative direction:"),i),console.log("Fetching all available directions for route ".concat(o));let s=await (0,d.Zx)(Number(o)),r=s.directions.map(e=>e.direction_id);console.log("Available directions for route ".concat(o,":"),r);let n=r.filter(e=>e!==Number(a));if(n.length>0){let s=!1;for(let r of n){console.log("Trying alternative direction ".concat(r," for route ").concat(o));try{e=await (0,d.rN)(Number(o),Number(t),r),console.log("Successfully fetched stops using alternative direction ".concat(r)),s=!0;break}catch(e){console.error("Direction ".concat(r," also failed:"),e)}}if(!s)throw Error("All available directions failed")}else throw Error("No alternative directions available")}}else console.log("Using PTV API for route type ".concat(t)),e=await (0,d.rN)(Number(o),Number(t),Number(a))}catch(t){console.error("Error fetching stops:",t),e={stops:[],status:{version:"",health:0}}}console.log("All stops with sequence info:",e.stops.map(e=>({name:e.stop_name,id:e.stop_id,sequence:e.stop_sequence}))),console.log("Processing stops - using API stop_sequence for ordering");let s=[...e.stops].sort((e,t)=>{if(e.stop_sequence&&t.stop_sequence)return e.stop_sequence-t.stop_sequence;if(e.stop_sequence)return -1;if(t.stop_sequence)return 1;let o=e.stop_name.match(/#(\d+)/),s=t.stop_name.match(/#(\d+)/);return o&&s?parseInt(o[1])-parseInt(s[1]):e.stop_id-t.stop_id});console.log("Sorted stops:",s.map(e=>({name:e.stop_name,sequence:e.absolute_sequence,original_sequence:e.stop_sequence})));let r=s.findIndex(e=>e.stop_id===Number(l));if(-1===r){w("Current stop not found in route stops"),y(!1);return}let n=s[r];h(n);let i=s.slice(r+1);if(v(i),i.length>0){let e=i.map(e=>({latitude:e.stop_latitude,longitude:e.stop_longitude,stopId:e.stop_id,stopName:e.stop_name,stopSequence:e.absolute_sequence||e.stop_sequence})),o=await (0,p.xc)(e),s=new Date().toISOString();console.log("Current time for gig reachability: ".concat(s)),console.log("Found ".concat(o.length," nearby gigs before travel time calculation"));let r=o.map(async e=>{let o=i.find(t=>t.stop_id===e.stopId);if(!o)return null;try{console.log("Getting travel time from stop ".concat(l," to ").concat(o.stop_id));let r=await (0,d.Z$)(Number(l),o.stop_id,Number(t));console.log("Travel time: ".concat(r," minutes"));let n="".concat(e.date,"T").concat(e.start_time||"19:00:00");console.log("Gig start time: ".concat(n));let a=(0,p.l2)(n,s,r);return console.log('Gig "'.concat(e.name,'" at ').concat(e.venue.name," is ").concat(a?"reachable":"not reachable")),{...e,travelTimeMinutes:r,isReachable:a}}catch(t){return console.error("Error getting travel time:",t),{...e,travelTimeMinutes:30,isReachable:!0}}}),n=(await Promise.all(r)).filter(Boolean);console.log("Found ".concat(n.length," gigs after travel time calculation"));let a=new Map;n.forEach(e=>{if(a.has(e.id)){let t=a.get(e.id);(e.distance_meters||0)<(t.distance_meters||0)&&a.set(e.id,e)}else a.set(e.id,e)});let c=Array.from(a.values()).sort((e,t)=>{let o=e.start_time||"19:00:00",s=t.start_time||"19:00:00",r=e.date.localeCompare(t.date);return 0!==r?r:o.localeCompare(s)});console.log("Deduplicated to ".concat(c.length," unique gigs")),console.log("Reachable gigs: ".concat(c.filter(e=>e.isReachable).length)),b(c)}y(!1)}catch(e){w("Failed to load stops ahead. Please try again later."),y(!1),console.error("Error fetching stops ahead:",e)}};fetchStopsAndGigs()},[t,o,l,a]);let j=t&&m[t]||"ptv-blue";return(0,s.jsxs)(u.Z,{children:[(0,s.jsx)(i(),{children:(0,s.jsx)("title",{children:"PTV-LML | Stops Ahead"})}),(0,s.jsxs)("div",{className:"container py-8",children:[(0,s.jsxs)("div",{className:"mb-8",children:[(0,s.jsxs)(c(),{href:"/routes/".concat(t,"/").concat(o),className:"text-ptv-blue hover:underline mb-4 inline-flex items-center",children:[(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z",clipRule:"evenodd"})}),"Back to Route"]}),(0,s.jsx)("h1",{className:"text-3xl font-bold text-".concat(j," mb-2 md:text-4xl"),children:"Stops Ahead"}),(0,s.jsx)("p",{className:"text-gray-600",children:g?"Live music ahead of ".concat(g.stop_name):"Loading..."})]}),_?(0,s.jsx)("div",{className:"flex justify-center items-center py-12",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-ptv-blue"})}):N?(0,s.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[(0,s.jsx)("strong",{className:"font-bold",children:"Error!"}),(0,s.jsxs)("span",{className:"block sm:inline",children:[" ",N]})]}):(0,s.jsx)("div",{className:"space-y-6",children:x.length>0?(0,s.jsxs)(s.Fragment,{children:[x.filter(e=>e.isReachable).length>0&&(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-green-600 mb-3",children:"Reachable Gigs"}),(0,s.jsx)("div",{className:"space-y-4",children:x.filter(e=>e.isReachable).sort((e,t)=>{let o=e.start_time||"19:00:00",s=t.start_time||"19:00:00",r=e.date.localeCompare(t.date);return 0!==r?r:o.localeCompare(s)}).map(e=>(0,s.jsxs)("div",{className:"card p-4 border-l-4 border-green-500",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-music-purple",children:e.name}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:e.genre_tags.join(", ")}),(0,s.jsxs)("p",{className:"text-sm font-medium mt-1",children:[e.venue.name,", ",e.start_time?e.start_time.substring(0,5):"8:00"," pm"]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center text-xs text-gray-500",children:[(0,s.jsx)("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full mr-1"}),(0,s.jsxs)("span",{children:[Math.round(e.distance_meters||0),"m from ",e.stopName]}),(0,s.jsx)("span",{className:"mx-2",children:"•"}),(0,s.jsxs)("span",{children:["~",e.travelTimeMinutes," min travel time"]})]}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("a",{href:"https://www.google.com/maps/dir/?api=1&destination=".concat(e.venue.latitude,",").concat(e.venue.longitude),target:"_blank",rel:"noopener noreferrer",className:"text-sm text-ptv-blue hover:underline",children:"Venue Directions"})})]},"".concat(e.id,"-").concat(e.stopId)))})]}),x.filter(e=>!e.isReachable).length>0&&(0,s.jsxs)("div",{className:"mt-8",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-yellow-600 mb-3",children:"Other Gigs"}),(0,s.jsx)("div",{className:"space-y-4",children:x.filter(e=>!e.isReachable).sort((e,t)=>{let o=e.start_time||"19:00:00",s=t.start_time||"19:00:00",r=e.date.localeCompare(t.date);return 0!==r?r:o.localeCompare(s)}).map(e=>(0,s.jsxs)("div",{className:"card p-4 border-l-4 border-yellow-400 opacity-80",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-music-purple",children:e.name}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:e.genre_tags.join(", ")}),(0,s.jsxs)("p",{className:"text-sm font-medium mt-1",children:[e.venue.name,", ",e.start_time?e.start_time.substring(0,5):"8:00"," pm"]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center text-xs text-gray-500",children:[(0,s.jsx)("span",{className:"inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"}),(0,s.jsxs)("span",{children:[Math.round(e.distance_meters||0),"m from ",e.stopName]}),(0,s.jsx)("span",{className:"mx-2",children:"•"}),(0,s.jsxs)("span",{children:["~",e.travelTimeMinutes," min travel time"]})]}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("a",{href:"https://www.google.com/maps/dir/?api=1&destination=".concat(e.venue.latitude,",").concat(e.venue.longitude),target:"_blank",rel:"noopener noreferrer",className:"text-sm text-ptv-blue hover:underline",children:"Venue Directions"})})]},"".concat(e.id,"-").concat(e.stopId)))})]})]}):(0,s.jsx)("div",{className:"text-center py-8",children:(0,s.jsx)("p",{className:"text-gray-500",children:"No upcoming gigs found at stops ahead."})})})]})]})}}},function(e){e.O(0,[714,664,675,66,817,910,774,888,179],function(){return e(e.s=7026)}),_N_E=e.O()}]);